@page "/data-binding"
@rendermode InteractiveServer
@using BlazorDiagrams.Core.Geometry
@using BlazorDiagrams.Core.Components

<div class="container">
    <div class="controls">
        <button @onclick="AddUser">Add User</button>
        <button @onclick="RemoveUser">Remove Last User</button>
        <button @onclick="ModifyUser">Modify First User</button>
    </div>

    <div class="diagram-container">
        <DiagramData Items="@_users" 
                     KeySelector="@(u => u.Id)" 
                     PositionSelector="@(u => u.Location)">
            
            <NodeTemplate Context="user">
                <div class="user-card @(user.Role == "Admin" ? "admin" : "")">
                    <div class="header">@user.Name</div>
                    <div class="role">@user.Role</div>
                </div>
            </NodeTemplate>

        </DiagramData>
    </div>
</div>

<style>
    .container {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 10px;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        padding: 10px;
        background: #f5f5f5;
    }
    
    .diagram-container {
        flex-grow: 1;
        border: 1px solid #ddd;
        height: 600px;
    }

    .user-card {
        width: 150px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .user-card.admin {
        border-color: #d9534f;
    }
    
    .user-card .header {
        background: #f8f9fa;
        padding: 8px;
        font-weight: bold;
        border-bottom: 1px solid #eee;
    }
    
    .user-card.admin .header {
        background: #d9534f;
        color: white;
    }
    
    .user-card .role {
        padding: 8px;
        font-size: 0.9em;
        color: #666;
    }
</style>

@code {
    private List<User> _users = new();
    private int _counter = 1;

    protected override void OnInitialized()
    {
        // Initial data
        _users.Add(new User { Id = "1", Name = "Alice", Role = "Admin", Location = new Point(100, 100) });
        _users.Add(new User { Id = "2", Name = "Bob", Role = "User", Location = new Point(300, 100) });
        _users.Add(new User { Id = "3", Name = "Charlie", Role = "User", Location = new Point(100, 250) });
        _counter = 4;
    }

    private void AddUser()
    {
        var id = _counter++.ToString();
        var x = new Random().Next(50, 500);
        var y = new Random().Next(50, 400);
        
        _users.Add(new User 
        { 
            Id = id, 
            Name = $"User {id}", 
            Role = "User", 
            Location = new Point(x, y) 
        });
    }

    private void RemoveUser()
    {
        if (_users.Any())
        {
            _users.RemoveAt(_users.Count - 1);
        }
    }

    private void ModifyUser()
    {
        if (_users.Any())
        {
            var user = _users.First();
            user.Name = user.Name + "*";
            // Force re-render to show name change
            // In a real app with ObservableCollection or INotifyPropertyChanged, this might be automatic
            // But DiagramData checks reference or collection changes.
            // For property changes inside an item, we might need to trigger update manually if the item instance is same.
            // However, DiagramData.razor currently doesn't listen to property changes of T.
            // So we might need to replace the item or trigger StateHasChanged on DiagramData (which happens when parent renders).
        }
    }

    private void OnUserChanged(User user)
    {
        Console.WriteLine($"User {user.Name} changed. New location: {user.Location}");
    }

    public class User
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Role { get; set; } = "";
        public Point Location { get; set; }
    }
}
