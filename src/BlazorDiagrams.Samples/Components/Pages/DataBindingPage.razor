@page "/databinding"
@rendermode InteractiveServer
@using BlazorDiagrams.Core.Geometry
@using BlazorDiagrams.Samples.Components.Shared

<PageTitle>Data Binding Sample</PageTitle>

<h1>Data Binding Example</h1>

<p>Demonstration of the DiagramData component for binding data to the diagram.</p>

<div style="margin-bottom: 20px;">
    <button class="btn btn-primary" @onclick="AddUser">Add User</button>
    <button class="btn btn-danger" @onclick="RemoveUser">Remove Last User</button>
    <button class="btn btn-secondary" @onclick="ModifyUser">Modify Random User</button>
    <button class="btn btn-info" @onclick="AddRandomLink">Add Random Link</button>
    <button class="btn btn-warning" @onclick="RemoveLastLink">Remove Last Link</button>
</div>

<div style="border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
    <DiagramData T="User"
                 Items="@_users" 
                 KeySelector="@(u => u.Id)" 
                 PositionSelector="@(u => u.Location)"
                 Links="@_links"
                 LinkSourceKeySelector="@(l => ((LinkData)l).SourceId)"
                 LinkTargetKeySelector="@(l => ((LinkData)l).TargetId)">
        <NodeTemplate Context="user">
            <div style="width: 100%; height: 100%; padding: 10px; 
                        background: white; 
                        border-radius: 5px;
                        border: 2px solid #007bff;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;">
                <div style="font-weight: bold;">@user.Name</div>
                <div style="font-size: 12px; color: #666;">@user.Role</div>
            </div>
        </NodeTemplate>
    </DiagramData>
</div>

<div class="mt-3">
    <strong>Users:</strong> @_users.Count | <strong>Links:</strong> @_links.Count
</div>

<CodeSnippet Title="DataBindingPage.razor" Code="@SnippetCode" />

@code {
    private List<User> _users = new();
    private List<LinkData> _links = new();
    private int _userCounter = 1;
    private Random _random = new();

    protected override void OnInitialized()
    {
        // Initial data
        _users.Add(new User { Id = "1", Name = "Alice", Role = "Manager", Location = new Point(100, 100) });
        _users.Add(new User { Id = "2", Name = "Bob", Role = "Developer", Location = new Point(300, 100) });
        _users.Add(new User { Id = "3", Name = "Charlie", Role = "Designer", Location = new Point(200, 250) });
        _userCounter = 4;

        // Initial links
        _links.Add(new LinkData("1", "2"));
        _links.Add(new LinkData("2", "3"));
    }

    private void AddUser()
    {
        _users.Add(new User 
        { 
            Id = _userCounter.ToString(), 
            Name = $"User {_userCounter}", 
            Role = "Employee", 
            Location = new Point(_random.Next(50, 500), _random.Next(50, 400)) 
        });
        _userCounter++;
    }

    private void RemoveUser()
    {
        if (_users.Any())
        {
            var userToRemove = _users.Last();
            _users.Remove(userToRemove);
            
            // Remove associated links
            _links.RemoveAll(l => l.SourceId == userToRemove.Id || l.TargetId == userToRemove.Id);
        }
    }

    private void ModifyUser()
    {
        if (_users.Any())
        {
            var user = _users[_random.Next(_users.Count)];
            user.Name = $"{user.Name} (Modified)";
            // Force UI update since we're modifying an object inside the list
            // In a real app, you might use ObservableCollection or similar
            StateHasChanged();
        }
    }

    private void AddRandomLink()
    {
        if (_users.Count < 2) return;

        var source = _users[_random.Next(_users.Count)];
        var target = _users[_random.Next(_users.Count)];

        if (source.Id != target.Id && !_links.Any(l => l.SourceId == source.Id && l.TargetId == target.Id))
        {
            _links.Add(new LinkData(source.Id, target.Id));
        }
    }

    private void RemoveLastLink()
    {
        if (_links.Any())
        {
            _links.RemoveAt(_links.Count - 1);
        }
    }

    public class User
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Role { get; set; } = "";
        public Point Location { get; set; }
    }

    public class LinkData
    {
        public string SourceId { get; set; }
        public string TargetId { get; set; }

        public LinkData(string sourceId, string targetId)
        {
            SourceId = sourceId;
            TargetId = targetId;
        }
    }

    private const string SnippetCode = @"<DiagramData Items=""@_users"" 
             KeySelector=""@(u => u.Id)"" 
             PositionSelector=""@(u => u.Location)""
             Links=""@_links""
             LinkSourceKeySelector=""@(l => ((LinkData)l).SourceId)""
             LinkTargetKeySelector=""@(l => ((LinkData)l).TargetId)"">
    <NodeTemplate Context=""user"">
        <div class=""node"">
            <div>@user.Name</div>
            <div>@user.Role</div>
        </div>
    </NodeTemplate>
</DiagramData>

@code {
    private List<User> _users = new();
    private List<LinkData> _links = new();

    protected override void OnInitialized()
    {
        // Add users
        _users.Add(new User { Id = ""1"", ... });
        
        // Add links
        _links.Add(new LinkData(""1"", ""2""));
    }
}";
}
