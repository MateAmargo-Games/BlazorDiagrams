@page "/circular"
@rendermode InteractiveServer

<PageTitle>Circular Layout Sample</PageTitle>

<h1>Circular Layout Example</h1>

<p>Demonstration of CircularLayout for radial and circular graph arrangements.</p>

<div style="margin-bottom: 20px;">
    <button class="btn btn-primary" @onclick="ApplyLayout">Apply Layout</button>
    <button class="btn btn-secondary" @onclick="AddNode">Add Node</button>
    <button class="btn btn-info" @onclick="ToggleLinks">@(_showAllLinks ? "Show Selected Links" : "Show All Links")</button>
    <button class="btn btn-warning" @onclick="Randomize">Randomize</button>
</div>

<div class="mb-3">
    <label>Radius: @_radius px</label>
    <input type="range" class="form-range" min="100" max="300" step="10" @bind="_radius" @bind:event="oninput" @onchange="ApplyLayout" />
</div>

<div style="border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
    <Diagram Model="@_model" 
             Width="100%" 
             Height="700px"
             ShowGrid="false"
             ShowZoomControls="true"
             BackgroundColor="#f8f9fa">
        <NodeTemplate Context="node">
            <div style="width: 100%; height: 100%; 
                        background: @GetNodeGradient(node); 
                        border-radius: 50%;
                        border: 3px solid @(node.IsSelected ? "#fff" : "#555");
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-direction: column;
                        color: white;
                        cursor: pointer;
                        transition: all 0.3s ease;">
                @if (node.Data is CircleNodeData data)
                {
                    <div style="font-weight: bold; font-size: 14px;">@data.Label</div>
                    @if (data.Value.HasValue)
                    {
                        <div style="font-size: 11px; opacity: 0.9;">@data.Value</div>
                    }
                }
            </div>
        </NodeTemplate>
    </Diagram>
</div>

<div class="mt-3 alert alert-info">
    <strong>Tip:</strong> El Circular Layout es ideal para visualizar relaciones donde todos los nodos tienen importancia similar. 
    Ajusta el radio para cambiar la densidad del layout.
</div>

@code {
    private DiagramModel _model = new();
    private int _nodeCounter = 9;
    private double _radius = 200;
    private bool _showAllLinks = true;

    protected override void OnInitialized()
    {
        InitializeCircularGraph();
    }

    private void InitializeCircularGraph()
    {
        var random = new Random(42);
        
        // Create nodes
        string[] labels = { "Alpha", "Beta", "Gamma", "Delta", "Epsilon", "Zeta", "Eta", "Theta" };
        
        for (int i = 0; i < labels.Length; i++)
        {
            var node = _model.AddNode($"node{i + 1}", new Point(400, 350), new CircleNodeData
            {
                Label = labels[i],
                Value = random.Next(10, 100),
                Category = i % 3
            });
            node.Size = new Size(80, 80);
        }

        // Create some links
        var nodes = _model.Nodes.ToList();
        for (int i = 0; i < nodes.Count; i++)
        {
            // Connect to next node
            var nextIndex = (i + 1) % nodes.Count;
            _model.AddLink(nodes[i], nodes[nextIndex]);
            
            // Connect to node across
            if (i < nodes.Count / 2)
            {
                _model.AddLink(nodes[i], nodes[i + nodes.Count / 2]);
            }
        }

        ApplyLayout();
    }

    private void ApplyLayout()
    {
        var layout = new CircularLayout
        {
            Radius = _radius,
            StartAngle = 0,
            AutoRadius = false
        };

        layout.Apply(_model);
        StateHasChanged();
    }

    private void AddNode()
    {
        var node = _model.AddNode($"node{_nodeCounter}", new Point(400, 350), new CircleNodeData
        {
            Label = $"Node {_nodeCounter}",
            Value = new Random().Next(10, 100),
            Category = _nodeCounter % 3
        });
        node.Size = new Size(80, 80);
        _nodeCounter++;

        // Connect to random existing node
        var nodes = _model.Nodes.Where(n => n.Id != node.Id).ToList();
        if (nodes.Any())
        {
            var randomNode = nodes[new Random().Next(nodes.Count)];
            _model.AddLink(randomNode, node);
        }

        ApplyLayout();
    }

    private void ToggleLinks()
    {
        _showAllLinks = !_showAllLinks;
        
        if (_showAllLinks)
        {
            // Show all links
            foreach (var link in _model.Links)
            {
                link.IsVisible = true;
            }
        }
        else
        {
            // Only show links to/from selected nodes
            var selectedNodes = _model.GetSelectedNodes().ToList();
            foreach (var link in _model.Links)
            {
                link.IsVisible = (link.FromNode != null && selectedNodes.Contains(link.FromNode)) || 
                                (link.ToNode != null && selectedNodes.Contains(link.ToNode));
            }
        }
    }

    private void Randomize()
    {
        var random = new Random();
        
        // Randomize node data
        foreach (var node in _model.Nodes)
        {
            if (node.Data is CircleNodeData data)
            {
                data.Value = random.Next(10, 100);
                data.Category = random.Next(0, 3);
            }
        }

        ApplyLayout();
    }

    private string GetNodeGradient(Node node)
    {
        if (node.Data is CircleNodeData data)
        {
            return data.Category switch
            {
                0 => "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                1 => "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                2 => "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                _ => "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)"
            };
        }
        return "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
    }

    public class CircleNodeData
    {
        public string Label { get; set; } = "";
        public int? Value { get; set; }
        public int Category { get; set; }
    }
}

